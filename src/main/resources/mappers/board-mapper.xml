<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">

	<resultMap type="boardDto" id="BoardResult">
		<id column="board_no" property="boardNo"/>
		<result column="sub_no" property="subNo"/>
		<result column="board_title" property="boardTitle"/>
		<result column="mem_name" property="memNo"/>
		<result column="enroll_date" property="enrollDate"/>
		<result column="read_count" property="readCount"/>
		<result column="board_type" property="boardType"/>
		<result column="attach_Count" property="attachCount"/>
	</resultMap>
	
	
	<!-- 전체글 갯수 조회 -->
	<select id="selectBoardListCount" resultType="_int">
		select
				count(*)
		   from tb_board
		  where status = 'Y'
	</select>
	
	<!-- 전체글 목록 조회 -->
	<select id="selectBoardList" resultMap="BoardResult">
		select
				sub_no
			  , board_title
			  , mem_name
			  , b.enroll_date
			  , read_count
			  ,
			  (
			  	select count(*)
			  	from tb_attachment
			  	where ref_no = sub_no
			  )attachCount
			  from tb_board b
			  join tb_mem using (mem_no)
			 where b.status = 'Y'
			 order
			 	by sub_no desc
	</select>
	
	<select id="selectLatestPostList" resultMap="BoardResult">
		select
				board_type
			  , board_title
		  from (
		  	select *
		  	from tb_board 
		  	order
		  	   by enroll_date desc
		  )
		  where rownum between 1 and 5
	</select>
	
	
	<select id="searchBoardListCount" resultType="_int">
		select
				count(*)
		   from tb_board b
		   join tb_mem using (mem_no)
		  where b.status = 'Y'
		  	and 
		  	(
		  	 board_title like '%' || #{keyword} || '%'
		  	 or mem_name like '%' || #{keyword} || '%'
		  	 or b.enroll_date like '%' || #{keyword} || '%'
		  	 )
	</select>
	
	
	<select id="searchBoardList" resultMap="BoardResult">
		select
				sub_no
			  , board_title
			  , mem_name
			  , b.enroll_date
			  , read_count
			  ,(
				  select count(*)
				    from tb_attachment
				   where ref_no = b.sub_no
			  )
			  from tb_board b
			  join tb_mem using (mem_no)
			 where b.status = 'Y'
			 and 
			  (
			  mem_name like '%' || #{keyword} || '%'
			  or board_title like '%' || #{keyword} || '%'
			  or b.enroll_date like '%' || #{keyword} || '%'
			  )
			 order
			 	by sub_no desc
	</select>
	
	
	<insert id="insertBoard" >
		insert
		  into tb_board
		  (
		    board_no
		  , sub_no
		  , board_title
		  , mem_no
		  , board_content
		  , board_type
		  )
		  values
		  (
		    case
		    	when #{boardType} = 'NO' then seq_nno.nextval
		    	when #{boardType} = 'CO' then seq_cno.nextval
		    end
		    , seq_bno.nextval
		    , #{boardTitle}
		    , #{memNo}
		    , #{boardContent}
		    , #{boardType}
		     	
		  )
		    
	</insert>
	
	<insert id="insertAttach">
		insert
				into tb_attachment
				(
				  file_no
				, file_path
				, system_name
				, origin_name
				, type
				, ref_no
				)
				values
				(
				  seq_fileno.nextval
				, #{filePath}
				, #{systemName}
				, #{originName}
				, #{type}
				, 
				case
		    	when #{type} = 'N' then seq_nno.currval
		    	when #{type} = 'C' then seq_cno.currval
		    	end
				)
	
	</insert>
	


</mapper>